<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="Transparent Ham Studios">

    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <title>GAMEPAD</title>
    <link rel="stylesheet" type="text/css" href="index.css">
  </head>
  <body>
    <h1>Gamepad API Test</h1>
    <p id="gamepad-msg">Waiting for gamepad ...</p>
    <div id="gamepad-lanes"></div>
  
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/javascript" src="bower_components/jquery/dist/jquery.min.js"></script>
    <script>
      $(document).ready(function(){
        
      });
      
      var rafId = 0; // will be non-zero if callback is active
      var haveEvents = 'ongamepadconnected' in window;
      var controllers = {};

      function connecthandler(e) {
        addgamepad(e.gamepad);
        rafId = requestAnimationFrame(updateStatus);
      }

      function addgamepad(gamepad) {
        controllers[gamepad.index] = gamepad;

        // for (var i = 0; i < gamepad.buttons.length; i++) {
        //   
        // }
        // 
        // for (var i = 0; i < gamepad.axes.length; i++) {
        //   
        // }
      }

      function disconnecthandler(e) {
        removegamepad(e.gamepad);
        
        // stop our animation loop if the last controller was disconnected
        if(Object.keys(controllers).length === 0){
          cancelAnimationFrame(rafId);
          rafId = 0;
        }
      }

      function removegamepad(gamepad) {
        delete controllers[gamepad.index];
      }

      function updateStatus() {
        var i = 0;
        var j;

        for (j in controllers) {
          var controller = controllers[j];

          // for (i = 0; i < controller.buttons.length; i++) {
          //   var val = controller.buttons[i];
          //   var pressed = val == 1.0;
          //   if (typeof(val) == "object") {
          //     pressed = val.pressed;
          //     val = val.value;
          //   }
          // 
          //   var pct = Math.round(val * 100) + "%"; // for analog triggers
          //   
          //   // ---
          // }

          for (i = 0; i < controller.axes.length; i++) {
            // controller.axes[i] + 1 -> moves range to [0, 2]
          }
        }

        rafId = requestAnimationFrame(updateStatus);
      }
      
      function scanhandler(){
        scangamepads();
        
        // Possibilities:
        // 0 -> 0: request, then imm. cancel frame
        // 0 -> 1+: request frame
        // 1+ -> 0: cancel frame
        // 1+ -> 1+: do nothing
        
        if(rafId === 0)
          rafId = requestAnimationFrame(updateStatus);
        
        // stop our animation loop if the last controller was disconnected
        if(Object.keys(controllers).length === 0){
          cancelAnimationFrame(rafId);
          rafId = 0;
        }
      }

      function scangamepads() {
        // Completely wipe the controllers object, to capture removed gamepads as well.
        controllers = {};
      
        var gamepads = navigator.getGamepads ? navigator.getGamepads() : (navigator.webkitGetGamepads ? navigator.webkitGetGamepads() : []);
        
        if(!gamepads) // will be null if no controllers connected, or empty array if not supported
          return;
        
        for (var i = 0; i < gamepads.length; i++) {
          if (gamepads[i]) // MDN claims that the first elem is always null
            addgamepad(gamepads[i]);
        }
      }


      window.addEventListener("gamepadconnected", connecthandler);
      window.addEventListener("gamepaddisconnected", disconnecthandler);

      if (!haveEvents) {
        setInterval(scanhandler, 500);
      }
    </script>
  </body>
</html>